<!DOCTYPE html>
<html lang="en">
  <head>
    <title>Music Coding</title>

    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, shrink-to-fit=no"
    />
    <meta name="theme-color" content="#000000" />

    <meta property="og:title" content="Music Coding" />
    <meta
      property="og:description"
      content="Musical code in WebAssembly-enabled browsers."
    />
   <meta property="og:url" content="https://ebmtranceboy.github.io/music/index.html" />

    <link
      rel="stylesheet"
      href="https://use.fontawesome.com/releases/v5.13.0/css/all.css"
     />
    <link
      href="https://fonts.googleapis.com/css?family=Raleway|Roboto:400,700"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="web/codemirror.css" />
    <link rel="stylesheet" href="web/theme/monokai.css" />
    <link rel="stylesheet" href="web/cslivecode.css" />
    <script src="web/codemirror.js"></script>
    <script src="web/mode/csound/csound.js"></script>
    <script src="web/addon/comment/comment.js"></script>
    <script src="web/addon/edit/matchbrackets.js"></script>
    <script src="web/addon/edit/closebrackets.js"></script>
    <script src="web/keymap/vim.js"></script>
    <script src="web/keymap/emacs.js"></script>

    <link rel="manifest" href="web/manifest.json" />

    <!---- GOLDEN LAYOUT -->
    <script
      type="text/javascript"
      src="https://code.jquery.com/jquery-1.11.1.min.js"
    ></script>

    <script
      type="text/javascript"
      src="https://golden-layout.com/files/latest/js/goldenlayout.min.js"
    ></script>
    <link
      type="text/css"
      rel="stylesheet"
      href="https://golden-layout.com/files/latest/css/goldenlayout-base.css"
    />

    <link
      type="text/css"
      rel="stylesheet"
      href="https://golden-layout.com/files/latest/css/goldenlayout-dark-theme.css"
    />
    
    <style>
    #code {
      height: 100%;
      font-family: Monaco, monospace;
      font-size: 14px;
    }
}

    </style>
  </head>

  <body>
    <div id="loadDiv">
      <code>... L O A D I N G &nbsp; C S O U N D ...</code>
    </div>
    <header>
      <h1>music-code</h1>
      <nav>
        <i
          id="playPauseButton"
          class="bar-btn fas fa-pause-circle"
          title="Pause Engine"
        ></i>
        <i
          id="restartButton"
          class="bar-btn fas fa-redo-alt"
          title="Restart Engine"
          onClick="restartPerf()"
        ></i>
        <i
          id="consoleButton"
          class="bar-btn fas fa-scroll"
          title="Console"
          onClick="toggleConsole()"
          ></i>
      </nav>
      <i
        id="helpButton"
        class="bar-btn fas fa-question-circle"
        style="float:right"
        title="Open Documentation in new Window"
      ></i>
    </header>
    
    <div id="console">  
      <div class='headerTab'>Console</div>
      <div id='consoleWrapper'>
        <pre id='consoleOutput'></pre>
      </div>
    </div>
    
    <textarea  id="code" rows="40" cols="80">
    </textarea>

    <script src="web/csound/CsoundObj.js"></script>
    <script>
      let cs;
      let livecodeOrc = '';
      let console;
      let consoleOutput;
      let displayConsole = true;
      let playPauseButton = document.getElementById("playPauseButton");
      let helpButton = document.getElementById("helpButton");
      let code= document.getElementById("code");
      
      const updatePlayPauseUI = () => {
        if (CSOUND_AUDIO_CONTEXT.state == "running") {
          playPauseButton.className = "bar-btn fas fa-pause-circle";
          playPauseButton.title = "Pause Engine";
        } else {
          playPauseButton.className = "bar-btn fas fa-play-circle";
          playPauseButton.title = "Resume Engine";
        }
      };

      const playPause = () => {
        if (CSOUND_AUDIO_CONTEXT.state == "running") {
          CSOUND_AUDIO_CONTEXT.suspend().then(updatePlayPauseUI);
        } else {
          CSOUND_AUDIO_CONTEXT.resume().then(updatePlayPauseUI);
        }
      };
      
      const openHelp = () => {
        const url =
          "https://github.com/kunstmusik/csound-live-code/blob/master/doc/intro.md";
        window.open(url);
      };

      const onRuntimeInitialized = () => {
        fetch("livecode.orc").then(function(response) {
          return response.text().then(function(v) {
            livecodeOrc = v;
            let ld = document.getElementById("loadDiv");
            console = document.getElementById("console");
            consoleOutput = document.getElementById("consoleOutput");
            toggleConsole();
 
            const finishLoadCsObj = function() {
              CSOUND_AUDIO_CONTEXT.resume().then(() => {
                cs = new CsoundObj();
                restart();

                if (ld != null) {
                  ld.remove();
                }
 
             });
            };

            if (CSOUND_AUDIO_CONTEXT.state != "running") {
              ld.innerHTML = "Tap to start Csound";
              ld.addEventListener("click", function() {
                finishLoadCsObj();
              });
            } else {
              finishLoadCsObj();
            }
          });
        });
      };

       
      function layoutComplete() {
        // Prevent Refresh

        window.onbeforeunload = function() {
          return "Are you...sure?";
        };

        // ServiceWorker for PWA
        if ("serviceWorker" in navigator) {
          navigator.serviceWorker.register("./service-worker.js").then(function() {
            console.log("Service Worker Registered");
          });
        }

        // Initialize Csound and load
        CsoundObj.importScripts("./web/csound/").then(() => {
          onRuntimeInitialized();
        });
        
        playPauseButton.addEventListener("click", playPause);
        helpButton.addEventListener("click", openHelp);
      }
      
      layoutComplete(); 


      const csoundMsgCallback = msg => {
        consoleOutput.innerHTML += msg + "\n";
      };

      const restart = () => {
        cs.reset();
        cs.setMessageCallback(csoundMsgCallback);
        cs.setOption("-m0");
        cs.setOption("-odac");
        cs.setOption("-+msg_color=false");
        cs.compileOrc("ksmps=32\n0dbfs=1\nnchnls=2\nnchnls_i=1\n"+livecodeOrc);
        cs.start();
      };

      
      function toggleConsole(){
        if(displayConsole) {
          console.style.visibility="hidden";
          displayConsole = false;
        }
        else {
          console.style.visibility="visible";
          displayConsole = true;
        }
      }
      
      function restartPerf(){
        restart();
        consoleOutput.innerHTML = "";
        cs.compileOrc(code.textContent);
      }

    </script>
  </body>
</html>
