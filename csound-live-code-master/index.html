<!DOCTYPE html>
<html lang="en">
  <head>
    <title>Live Coding with Csound</title>

    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, shrink-to-fit=no"
    />
    <meta name="theme-color" content="#000000" />

    <meta property="og:title" content="Live Coding with Csound" />
    <meta
      property="og:description"
      content="Live code music in WebAssembly-enabled browsers using Csound."
    />
    <meta
      property="og:image"
      content="http://live.csound.com/web/og_image.png"
    />
    <meta property="og:url" content="http://live.csound.com" />

    <link
      rel="stylesheet"
      href="https://use.fontawesome.com/releases/v5.1.1/css/all.css"
      integrity="sha384-O8whS3fhG2OnA5Kas0Y9l3cfpmYjapjI0E4theH4iuMD+pLhbf6JI0jIMfYcK3yZ"
      crossorigin="anonymous"
    />
    <link
      href="https://fonts.googleapis.com/css?family=Raleway|Roboto:400,700"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="web/codemirror.css" />
    <link rel="stylesheet" href="web/theme/monokai.css" />
    <link rel="stylesheet" href="web/cslivecode.css" />
    <script src="web/codemirror.js"></script>
    <script src="web/mode/csound/csound.js"></script>
    <script src="web/addon/comment/comment.js"></script>
    <script src="web/addon/edit/matchbrackets.js"></script>
    <script src="web/addon/edit/closebrackets.js"></script>
    <script src="web/keymap/vim.js"></script>
    <script src="web/keymap/emacs.js"></script>

    <link rel="manifest" href="web/manifest.json" />

    <!---- GOLDEN LAYOUT -->
    <script
      type="text/javascript"
      src="https://code.jquery.com/jquery-1.11.1.min.js"
    ></script>

    <script
      type="text/javascript"
      src="https://golden-layout.com/files/latest/js/goldenlayout.min.js"
    ></script>
    <link
      type="text/css"
      rel="stylesheet"
      href="https://golden-layout.com/files/latest/css/goldenlayout-base.css"
    />

    <link
      type="text/css"
      rel="stylesheet"
      href="https://golden-layout.com/files/latest/css/goldenlayout-dark-theme.css"
    />
  </head>

  <body>
    <div id="loadDiv">
      <code>... L O A D I N G &nbsp; C S O U N D ...</code>
    </div>
    <header>
      <h1>csound-live-code</h1>
      <nav>
        <i
          id="playPauseButton"
          class="bar-btn fas fa-pause-circle"
          title="Pause Engine"
        ></i>
        <i
          id="restartButton"
          class="bar-btn fas fa-redo-alt"
          title="Restart Engine"
        ></i>
        <i
          id="evalNowButton"
          class="bar-btn fas fa-code"
          title="Evaluate Now"
        ></i>
        <i
          id="evalMeasureButton"
          class="bar-btn fas fa-code"
          title="Evaluate at Measure"
        ></i>
      </nav>
      <i
        id="helpButton"
        class="bar-btn fas fa-question-circle"
        style="float:right"
        title="Open Documentation in new Window"
      ></i>
    </header>
    <!--<div id="csoundCodeEditor"></div>-->
    <div id="layoutRoot"></div>

    <script src="web/csound/CsoundObj.js"></script>
    <!--script src="web/cslivecode.js"></script-->
    <script>
      let cs;
      let livecodeOrc = '';
      let consoleOutput;
      
      const onRuntimeInitialized = () => {
        fetch("livecode.orc").then(function(response) {
          return response.text().then(function(v) {
            livecodeOrc = v;
            let ld = document.getElementById("loadDiv");
            consoleOutput = document.getElementById("consoleOutput");

            const finishLoadCsObj = function() {
              CSOUND_AUDIO_CONTEXT.resume().then(() => {
                cs = new CsoundObj();
                restart();

                if (ld != null) {
                  ld.remove();
                }
 
             });
            };

            if (CSOUND_AUDIO_CONTEXT.state != "running") {
              ld.innerHTML = "Tap to start Csound";
              ld.addEventListener("click", function() {
                finishLoadCsObj();
              });
            } else {
              finishLoadCsObj();
            }
          });
        });
      };

       
      function layoutComplete() {
        // Prevent Refresh

        window.onbeforeunload = function() {
          return "Are you...sure?";
        };

        // ServiceWorker for PWA
        if ("serviceWorker" in navigator) {
          navigator.serviceWorker.register("./service-worker.js").then(function() {
            console.log("Service Worker Registered");
          });
        }

        // Initialize Csound and load
        CsoundObj.importScripts("./web/csound/").then(() => {
          onRuntimeInitialized();
        });
      }
      
      layoutComplete(); 


      const csoundMsgCallback = msg => {
      };

      const restart = () => {
        cs.reset();
        cs.setMessageCallback(csoundMsgCallback);
        cs.setOption("-m0");
        cs.setOption("-odac");
        cs.setOption("-+msg_color=false");
        cs.compileOrc("ksmps=32\n0dbfs=1\nnchnls=2\nnchnls_i=1\n"+livecodeOrc);
        cs.start();
      };

       
      cs.compileOrc("instr 1\nasig=vco2(1,440)\nouts asig,asig\nendin\nschedule(1,0,-1)\n");

    </script>
  </body>
</html>
